name: Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          debug: true
          script: |
            echo "=== Starting deployment process ==="

            # Vérifier le répertoire
            if [ ! -d "/home/notia/Notia" ]; then
              echo "Directory does not exist, creating..."
              mkdir -p /home/notia/Notia
              cd /home/notia/Notia
              git clone https://github.com/votre-username/notia.git .
            else
              echo "Directory exists, proceeding with update..."
              cd /home/notia/Notia
            fi

            # Afficher la branche actuelle et le dernier commit
            echo "=== Current branch and commit ==="
            git branch
            git log -1

            # Pull des changements
            echo "=== Pulling latest changes ==="
            git pull origin master || { echo "Git pull failed"; exit 1; }

            # Installer les dépendances
            echo "=== Installing dependencies ==="
            npm install || { echo "npm install failed"; exit 1; }

            # Build
            echo "=== Building projects ==="
            npx nx run-many --target=build --projects=frontend,backend --skip-nx-cache --skipTests=true || { echo "Build failed"; exit 1; }

            # Vérifier les processus PM2
            echo "=== Current PM2 processes ==="
            pm2 list

            # Redémarrer les services
            echo "=== Restarting services ==="
            pm2 restart notia-frontend notia-backend || { echo "PM2 restart failed"; exit 1; }
            pm2 save

            echo "=== Deployment complete ==="
